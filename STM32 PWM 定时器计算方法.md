# 📝 STM32 PWM 定时器计算指南 (Zephyr RTOS)

在 STM32 中配置 PWM 时，核心挑战在于平衡 **系统时钟频率**、**预分频 (Prescaler)** 和 **计数器位宽 (16bit/32bit)**。

## 1. 核心硬件参数 (STM32L475/L476)
- **系统时钟 ($f_{Input}$)**: 通常为 **80 MHz**。
- **TIM3 / TIM4 位宽**: **16 位** (最大计数值为 $2^{16} - 1 = 65,535$)。
- **TIM2 / TIM5 位宽**: **32 位** (最大计数值约为 42 亿)。

## 2. 核心计算公式

PWM 的最终频率和占空比由以下逻辑决定：

$$f_{PWM} = \frac{f_{Input}}{(Prescaler + 1) \times Period_{Ticks}}$$

在 Zephyr 设备树中：
- `st,prescaler` 对应公式中的 $Prescaler$。
- `pwms` 属性中的 `period` (单位: ns) 经过驱动换算后对应 $Period_{Ticks}$。

---

## 3. 计算实例：20ms (50Hz) 平滑调光方案

### 第一步：计算理想的 Prescaler
为了让 16 位定时器支持 20ms 周期，且获得最高的调节精度（让 $Period_{Ticks}$ 尽量接近 65535），计算如下：

$$Prescaler + 1 = \frac{f_{Input} \times Period_{Sec}}{65,535}$$
$$Prescaler + 1 = \frac{80,000,000 \times 0.02}{65,535} \approx 24.4$$

**结论**：取整设为 **25**，即设备树填 **`24`**。

### 第二步：验证结果
当 $Prescaler = 24$ 时：
- **计数频率**：$80MHz / 25 = 3.2MHz$。
- **1个 Tick 的时间**：$312.5 ns$。
- **20ms 对应的 Ticks**：$20ms / 312.5ns = \mathbf{64,000}$。
- **状态**：$64000 < 65535$，**成功避开 16 位溢出错误 (-134)**。

---

## 4. 最佳实践配置 (Overlay)

将以下配置保存到你的 `.overlay` 文件中，即可实现 20ms 周期下的极高精度调光。

```dts
&timers3 {
    /* 关键：预分频设为 24 (即 25 分频) */
    st,prescaler = <24>;
    status = "okay";

    pwm3: pwm {
        status = "okay";
        pinctrl-0 = <&tim3_ch1_pb4>;
        pinctrl-names = "default";
    };
};
```

# 📊 STM32 PWM 参数配置速查表 (80MHz 时钟)

本表针对 **STM32L475/476** 系列（主频 80MHz）编写，特别优化了 **16 位定时器**（TIM3/TIM4）的兼容性，确保不会出现 `-134` (溢出) 错误。

## 1. 核心公式简述
- **Tick频率** = $80MHz / (Prescaler + 1)$
- **周期计数值 (ARR)** = $Tick频率 \times 目标周期(秒)$
- **16位限制**: ARR 必须 $< 65536$

---

## 2. 常用频率参数表 (适用于 16 位定时器)

| 目标频率 | 周期 (Period) | st,prescaler | 硬件计数值 (ARR) | 调光分辨率 | 应用建议 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **50 Hz** | 20,000,000 ns | **24** | 64,000 | 🌟 极高 (6.4万级) | 舵机、LED 呼吸灯 |
| **100 Hz** | 10,000,000 ns | **19** | 40,000 | 40,000 级 | 普通 LED 调光 |
| **1 kHz** | 1,000,000 ns | **1** | 40,000 | 40,000 级 | 电机、蜂鸣器 |
| **10 kHz** | 100,000 ns | **0** | 8,000 | 8,000 级 | 无频闪调光 |
| **20 kHz** | 50,000 ns | **0** | 4,000 | 4,000 级 | 超声波/无噪调光 |
| **100 kHz** | 10,000 ns | **0** | 800 | 800 级 | 高频电源控制 |

---

## 3. 快速选型逻辑 (新手指南)

### 情况 A：如果你需要高频率 (> 2kHz)
- **动作**：将 `st,prescaler` 设为 **0**。
- **优点**：获得最精确的时间步进（12.5ns）。
- **风险**：低频率时 ARR 会超过 65535。

### 情况 B：如果你需要低频率 (< 100Hz，如 20ms 周期)
- **动作**：将 `st,prescaler` 设为 **24** 或更高。
- **优点**：防止 16 位寄存器溢出，保持系统稳定。
- **风险**：无。

### 情况 C：如果你使用的是 32 位定时器 (TIM2 / TIM5)
- **动作**：无脑将 `st,prescaler` 设为 **0**。
- **理由**：32 位寄存器容量巨大，即便周期是 10 秒也不会溢出，且分辨率最高。

---

## 4. Zephyr 设备树代码片段

```dts
/* 示例：配置为 1kHz 频率 */
&timers3 {
    st,prescaler = <1>; // 2分频，计数频率 40MHz
    status = "okay";
    pwm3: pwm {
        status = "okay";
    };
};

/* 应用层引用 */
&test_node {
    pwms = <&pwm3 1 1000000 PWM_POLARITY_NORMAL>; // 1,000,000ns = 1ms = 1kHz
};
```

# 🧮 PWM 计算逻辑深度解析：从“时间”到“格数”

在 STM32 中，我们填入寄存器的数字（如 8000 或 64000）本质上是在告诉定时器：**“数多少下就重头开始”**。

## 1. 为什么用除法？ (10kHz 案例)

### 核心逻辑：分饼原理
* **总资源**：1 秒钟内，时钟这把“尺子”一共有 **80,000,000** 个小格 (Ticks)。
* **你的目标**：你要把这 1 秒钟均匀地切成 **10,000** 份（即 10kHz）。
* **计算问题**：每一份（每个周期）占多少个小格？

$$\text{每一份的格数 (Period Ticks)} = \frac{\text{1秒钟的总格数 (80MHz)}}{\text{1秒钟要分的份数 (10,000Hz)}}$$
$$80,000,000 \div 10,000 = 8,000 \text{ 格}$$

**结论**：只要定时器每数到 **8,000** 就跳回 0，它输出的频率就刚好是 **10kHz**。

---

## 2. 为什么 50Hz (20ms) 必须加 Prescaler？

当你尝试用同样的逻辑去切 50 份时：
$$80,000,000 \div 50 = 1,600,000 \text{ 格}$$

### 硬件天花板 (16-bit Limit)
* **16位水箱 (TIM3/4)**：最大只能数到 **65,535**。
* **冲突**：160 万格太大了，水箱装不下，会直接溢出报错。

### 解决方案：Prescaler (减速阀)
我们给水龙头加个 **25 倍减速阀**（即 `st,prescaler = <24>`）：
1.  **减速后的总格数**：$80,000,000 \div 25 = 3,200,000$ 格/秒。
2.  **重新切 50 份**：$3,200,000 \div 50 = \mathbf{64,000}$ 格。
3.  **结果**：64,000 成功装进 65,535 的水箱。

---

## 3. 万能计算公式（通俗版）

无论你想要什么频率，按这个步骤走：

### 第一步：算“原始格数”
$$\text{结果} = 80,000,000 \div \text{目标频率(Hz)}$$

### 第二步：看结果是否大于 65535
* **不大于**：直接把 `st,prescaler` 设为 `0`，把结果填进 `period`。
* **大于了**：必须设置 `st,prescaler`。

### 第三步：计算 Prescaler
$$Prescaler + 1 \approx \frac{\text{第一步算出的结果}}{65535}$$
* 向上取一个整数，减去 1 后填入设备树。

---

## 4. 总结：数字背后的物理意义
| 参数名称 | 物理意义 | 生活比喻 |
| :--- | :--- | :--- |
| **System Clock** | 1秒钟总共有的刻度 | 绳子的总长度 |
| **Frequency** | 1秒钟重复的次数 | 要剪成多少段 |
| **Period (ARR)** | 每一段包含的刻度数 | 每一段剪多少毫米 |
| **Prescaler** | 把刻度变粗，让总数变少 | 换一把刻度更粗的尺子 |
/* pandora_stm32l475.overlay */

/ {
	aliases {
		led1 = &green_led;
		ap3216c-i2c = &ap3216c;
	};

	chosen {
		zephyr,display = &st7789v;
	};

	leds {
		compatible = "gpio-leds";
        // <&gpioe 7 GPIO_ACTIVE_HIGH> 这一行可能需要调整
        // 但是对于 led 节点，这是一个标志，表示该引脚是低电平有效的。
        
        // 根据您的电路，低电平点亮，所以它是 GPIO_ACTIVE_LOW
        // 这将影响驱动程序对 "开/关" 的解释。

        // 步骤 1: 修正引脚极性 (这是最标准的做法)

		red_led: led_0 {
			gpios = <&gpioe 7 GPIO_ACTIVE_LOW>;
		};

		green_led: led_1 {
			gpios = <&gpioe 8 GPIO_ACTIVE_LOW>;
		};

		blue_led: led_2 {
			gpios = <&gpioe 9 GPIO_ACTIVE_LOW>;
		};
	};
};

&i2c3 {
	status = "okay";
    pinctrl-0 = <&i2c3_scl_pc0 &i2c3_sda_pc1>; // 确认PC0/PC1引脚 i2c3_scl_pc0,i2c3_sda_pc1
	pinctrl-names = "default";
    clock-frequency = <I2C_BITRATE_STANDARD>;
	// AP3216C 节点
    ap3216c: ap3216c@1e {
        compatible = "liteon,ap3216c"; // 兼容性字符串可以自定义
        reg = <0x1e>;               // 传感器I2C设备地址 (0x1E)
        status = "okay";
    };
};

/* SPI3配置 - LCD使用PB3(SCK)和PB5(MOSI) */
&spi3 {
	pinctrl-0 = <&spi3_sck_pb3 &spi3_mosi_pb5>;
	pinctrl-names = "default";
	status = "okay";

	cs-gpios = <&gpiod 7 GPIO_ACTIVE_LOW>;    // LCD_CS -> PD7

    /*
     * 1. MIPI DBI SPI Emulation Controller Node:
     * - compatible = "zephyr,mipi-dbi-spi" (满足 Kconfig 依赖)
     * - 包含控制显示屏的 GPIO 信号 (CS/DC/RESET)
     */
	mipi_dbi_ctrl: mipi_dbi_ctrl@0 {
        compatible = "zephyr,mipi-dbi-spi";
        reg = <0>; // 逻辑上的 SPI 片选地址 0
		spi-dev = <&spi3>;
		#address-cells = <1>;
		#size-cells = <0>;

        dc-gpios = <&gpiob 4 GPIO_ACTIVE_HIGH>;   // LCD_WR/DC -> PB4
        reset-gpios = <&gpiob 6 GPIO_ACTIVE_LOW>; // LCD_RESET -> PB6

        /*
         * 2. ST7789V Display Device Node:
         * - 兼容字符串只保留 "sitronix,st7789v"
         * - 成为 mipi_dbi_ctrl 的子节点
         */
        st7789v: st7789v@0 {
            compatible = "sitronix,st7789v";
            reg = <0>; // 在 MIPI DBI 总线上的地址
            mipi-max-frequency = <20000000>;
            mipi-mode = "MIPI_DBI_MODE_SPI_4WIRE"; // 明确指定 4 线 SPI 模式 (需要 DC 信号)

            width = <240>;
            height = <240>;
            x-offset = <0>;
            y-offset = <0>;
            vcom = <0x19>;
            gctrl = <0x35>;
            vrhs = <0x12>;
            vdvs = <0x20>;
            mdac = <0x00>;
            lcm = <0x2c>;
            colmod = <0x65>; // RGB565 colmod = <0x05>
            gamma = <0x01>;
            porch-param = [0c 0c 00 33 33];
            cmd2en-param = [5a 69 02 01];
            pwctrl1-param = [a4 a1];
            pvgam-param = [D0 04 0D 11 13 2B 3F 54 4C 18 0D 0B 1F 23];
            nvgam-param = [D0 04 0C 11 13 2C 3F 44 51 2F 1F 1F 20 23];
            ram-param = [00 F0];  // RAM 访问模式
            rgb-param = [CD 08 14];
        };
    };
};

